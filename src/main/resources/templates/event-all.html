<!DOCTYPE html>
<html lang="ru" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <title>Все мероприятия</title>
</head>
<body>
<div th:replace="~{fragments/navbar}"></div>

<!-- Сообщение об ошибке-->
<div th:if="${errorMessage}" style="padding: 1rem; margin-bottom: 1rem; background-color: #f8d7da; border: 1px solid #f5c6cb; border-radius: 5px;">
    <p th:text="${errorMessage}" style="margin: 0; color: #721c24;"></p>
</div>

<!-- Сообщение об успехе -->
<div th:if="${successMessage}" style="padding: 1rem; margin-bottom: 1rem; background-color: #d4edda; border: 1px solid #c3e6cb; border-radius: 5px;">
    <p th:text="${successMessage}" style="margin: 0; color: #155724;"></p>
</div>

<h1>Все мероприятия</h1>


<form method="get" action="/events/all">
    <div style="display: flex; align-items: center; flex-wrap: wrap; gap: 10px;">
        <!-- Поиск -->
        <input type="search"
               name="search"
               placeholder="Поиск по названию..."
               th:value="${search}"
               style="padding: 5px;">

        <!-- Фильтр по типу -->
        <select name="type" id="typeFilter" style="padding: 5px;">
            <option value="">Все типы</option>
            <option th:each="eventType : ${eventTypes}"
                    th:value="${eventType}"
                    th:text="${eventType}"
                    th:selected="${selectedType == eventType}">
            </option>
        </select>

        <!-- Фильтр по жанру -->
        <select name="genre" id="genreFilter" style="padding: 5px;">
            <option value="">Все жанры</option>
            <option th:each="genre : ${genres}"
                    th:value="${genre.name}"
                    th:text="${genre.name}"
                    th:selected="${selectedGenre == genre.name}">
            </option>
        </select>

        <!-- Кнопки действий -->
        <button type="submit">Искать</button>
        <a th:href="@{/events/all}">Сбросить</a>

        <!-- Кнопка добавления для админов -->
        <span sec:authorize="hasRole('ROLE_ADMIN')">
            <a th:href="@{/events/add}" style="margin-left: 10px;">
                <button type="button">Добавить мероприятие</button>
            </a>
        </span>
    </div>
</form>
<p>

</p>

<!-- Список мероприятий -->
<div th:each="e : ${eventInfos}" class="card" style="margin-bottom: 2rem; padding-bottom: 1rem; border-bottom: 1px solid #ddd;">
    <!-- Картинка -->
    <div>
        <img th:src="${e.imageUrl}"
             th:alt="${e.title}"
             width="400" height="300">
    </div>

    <h3 th:text="${e.title}"></h3>
    <p>
        <strong>Дата и время:</strong>
        <span th:text="${#temporals.format(e.dateTime, 'dd.MM.yyyy HH:mm')}"></span>
    </p>
    <p>
        <strong>Зал:</strong>
        <span th:text="${e.hallName}"></span>
    </p>
    <p>
        <strong>Свободных мест:</strong>
        <span th:text="${e.availableSeats}"></span>
    </p>

    <div style="margin-top: 0.5rem;">
        <a th:href="@{/events/event-details/{title}(title=${e.title})}">Подробнее</a>

        <span sec:authorize="!hasRole('ROLE_ADMIN')">
            | <a th:href="@{/bookings/create/{title}(title=${e.title})}">Бронировать билеты</a>
        </span>

        <span sec:authorize="hasRole('ROLE_ADMIN')" style="margin-left: 1rem;">
            <form th:action="@{/events/event-delete/{event-title}(event-title=${e.title})}"
                  method="post"
                  style="display: inline;"
                  onsubmit="return confirm('Вы уверены, что хотите удалить мероприятие \'' + '[[${e.title}]]' + '\'?')">
                <button type="submit">Удалить</button>
            </form>
        </span>
    </div>
</div>

<!-- Пагинация -->
<nav th:if="${totalPages != null && totalPages > 1}">
    <ul>
        <li th:if="${currentPage > 0}">
            <a th:href="@{/events/all(page=${currentPage - 1}, size=10,
                         search=${search}, type=${selectedType}, genre=${selectedGenre})}">
                « Назад
            </a>
        </li>

        <li th:each="i : ${#numbers.sequence(0, totalPages - 1)}">
            <a th:href="@{/events/all(page=${i}, size=10,
                         search=${search}, type=${selectedType}, genre=${selectedGenre})}"
               th:text="${i + 1}"
               th:classappend="${i == currentPage} ? 'active' : ''"></a>
        </li>

        <li th:if="${currentPage < totalPages - 1}">
            <a th:href="@{/events/all(page=${currentPage + 1}, size=10,
                         search=${search}, type=${selectedType}, genre=${selectedGenre})}">
                Вперёд »
            </a>
        </li>
    </ul>
</nav>

<!-- Сообщение, если ничего не найдено -->
<p th:if="${#lists.isEmpty(eventInfos)}">
    <em>Мероприятия не найдены. Попробуйте изменить критерии поиска!</em>
</p>

<p>
    <a th:href="@{/}">Вернуться на главную</a>
</p>

</body>

<footer th:replace="fragments/footer"></footer>

</html>